openapi: 3.0.0
info:
  version: "1.0"
  title: "Re:Action"
  description: API for Re:Action application
  license:
    name: MIT
servers:
  - url: http://localhost:5000/api/v1
    description: Development Server
  - url: https://re-action.onrender.com/api/v1
    description: Production Server

# ==================== PATHS ====================

paths:

  # ==================== USERS ====================

  /users/login:
    post:
      summary: User login
      description: Authenticate user and receive JWT token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: password123
      responses:
        '200':
          description: Login successful, returns JWT token
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    description: JWT authentication token
                  email:
                    type: string
                  id:
                    type: string
                  self:
                    type: string
                    description: Resource link
        '401':
          description: Wrong password
        '403':
          description: Account not activated
        '404':
          description: User not found

  /users/auth/google:
    post:
      summary: Google OAuth login/register
      description: Authenticate or register user via Google OAuth 2.0 credential
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [credential]
              properties:
                credential:
                  type: string
                  description: Google ID token
                neighborhood:
                  type: string
                  description: Neighborhood ID (optional, only used during registration)
      responses:
        '200':
          description: Authentication successful, returns JWT token
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  email:
                    type: string
                  id:
                    type: string
                  self:
                    type: string
        '401':
          description: Invalid Google token

  /users/register:
    post:
      summary: Register new citizen user
      description: Create a new user account (RF1)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, surname, email, password, age]
              properties:
                name:
                  type: string
                  example: Mario
                surname:
                  type: string
                  example: Rossi
                email:
                  type: string
                  format: email
                  example: mario.rossi@example.com
                password:
                  type: string
                  format: password
                  minLength: 6
                age:
                  type: integer
                  example: 25
                neighborhood:
                  type: string
                  description: Neighborhood ID (optional)
      responses:
        '201':
          description: User created successfully
        '400':
          description: Missing required fields, invalid email format, or weak password
        '409':
          description: Email already exists

  /users/me:
    get:
      summary: Get current user profile
      description: Get basic profile data for logged-in user
      security:
        - tokenAuth: []
      responses:
        '200':
          description: User profile data
          content:
            application/json:
              schema:
                type: object
                properties:
                  name:
                    type: string
                  surname:
                    type: string
                  email:
                    type: string
                  points:
                    type: integer
                  neighborhood_id:
                    type: string
        '401':
          description: Unauthorized
        '404':
          description: User not found
    put:
      summary: Update user profile
      description: Update profile data (name, surname, neighborhood) for logged-in user
      security:
        - tokenAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, surname]
              properties:
                name:
                  type: string
                surname:
                  type: string
                neighborhood:
                  type: string
                  description: Neighborhood ID (optional)
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  name:
                    type: string
                  surname:
                    type: string
                  email:
                    type: string
                  neighborhood_id:
                    type: string
        '400':
          description: Missing required fields
        '401':
          description: Unauthorized
        '404':
          description: User not found

  /users/activate:
    get:
      summary: Activate user account
      description: Verify activation token and activate user account. On success, redirects to frontend login page.
      parameters:
        - in: query
          name: token
          required: true
          schema:
            type: string
          description: Activation token received via email
      responses:
        '302':
          description: Account activated successfully, redirects to frontend login
          headers:
            Location:
              schema:
                type: string
              description: Redirect URL to frontend login page
        '400':
          description: Token missing, invalid, or expired
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

  /users/change-password:
    post:
      summary: Change user password
      description: Change password for logged-in user
      security:
        - tokenAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [current_password, new_password]
              properties:
                current_password:
                  type: string
                  format: password
                new_password:
                  type: string
                  format: password
                  minLength: 6
      responses:
        '200':
          description: Password changed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: Weak password or new password same as current
        '401':
          description: Current password incorrect
        '404':
          description: User not found

  /users/forgot-password:
    post:
      summary: Request password reset
      description: Generate and send password reset token via email
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email:
                  type: string
                  format: email
      responses:
        '200':
          description: Reset email sent (returns same message whether email exists or not to prevent enumeration)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: Email is required

  /users/me/badges:
    get:
      summary: Get user's badges
      description: Returns badges for the logged-in user (RF4)
      security:
        - tokenAuth: []
      responses:
        '200':
          description: List of badges
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Badge'
        '401':
          description: Unauthorized
        '404':
          description: User not found
        '500':
          description: Failed to fetch badges

  /users/me/dashboard:
    get:
      summary: Get user dashboard data
      description: Returns complete dashboard data for the logged-in user (RF3)
      security:
        - tokenAuth: []
      responses:
        '200':
          description: Dashboard data including stats, recent activity, badges
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
        '404':
          description: User not found
        '500':
          description: Failed to fetch dashboard data



  # ==================== TASKS ====================

  /tasks:
    get:
      summary: Get available tasks for user
      description: Returns tasks available for user's neighborhood (RF6)
      security:
        - tokenAuth: []
      responses:
        '200':
          description: List of available tasks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Task'
        '401':
          description: Unauthorized
        '404':
          description: User not found

  /tasks/all:
    get:
      summary: Get all tasks (Operators only)
      description: Returns all tasks in the system (operators/admins only)
      security:
        - tokenAuth: []
      responses:
        '200':
          description: List of all tasks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Task'
        '403':
          description: Unauthorized - Operators only
        '500':
          description: Failed to fetch tasks

  /tasks/create:
    post:
      summary: Create new task (Operators only)
      description: Create a new task in the system
      security:
        - tokenAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskCreate'
      responses:
        '201':
          description: Task created successfully
          headers:
            Location:
              schema:
                type: string
              description: URI of the created task
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '403':
          description: Unauthorized - Operators only

  /tasks/submit:
    post:
      summary: Submit task completion
      description: |
        User submits a task for verification (RF12).
        Supports multipart/form-data for photo upload.
        - Manual tasks go to PENDING status
        - GPS/QR tasks are verified automatically
      security:
        - tokenAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [task_id]
              properties:
                task_id:
                  type: string
                  description: ID of the task to submit
                proof:
                  type: object
                  description: Proof data (JSON or form fields)
                photo:
                  type: string
                  format: binary
                  description: Photo proof file
          application/json:
            schema:
              type: object
              required: [task_id]
              properties:
                task_id:
                  type: string
                proof:
                  type: object
                  description: Proof data (GPS, QR, quiz answers, etc.)
      responses:
        '200':
          description: Task submitted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  submission_status:
                    type: string
                    enum: [PENDING, APPROVED]
                  points_earned:
                    type: integer
                  new_badges:
                    type: array
                    items:
                      $ref: '#/components/schemas/Badge'
        '400':
          description: Validation failed, task already completed, or verification failed
        '401':
          description: Unauthorized

  /tasks/submissions:
    post:
      summary: Get task submissions (Operators only)
      description: View task submissions, optionally filtered by status
      security:
        - tokenAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [PENDING, APPROVED, REJECTED]
                  description: Filter by submission status
      responses:
        '200':
          description: List of submissions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Submission'
        '403':
          description: Unauthorized

  /tasks/submissions/{id}/verify:
    post:
      summary: Verify task submission (Operators only)
      description: Approve or reject a manual task submission
      security:
        - tokenAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Submission ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [verdict]
              properties:
                verdict:
                  type: string
                  enum: [approved, rejected]
      responses:
        '200':
          description: Submission verified
          content:
            application/json:
              schema:
                type: object
                properties:
                  new_badges:
                    type: array
                    items:
                      $ref: '#/components/schemas/Badge'
        '400':
          description: Invalid verdict or submission already processed
        '403':
          description: Unauthorized
        '404':
          description: Submission not found

  /tasks/templates:
    get:
      summary: Get task templates (RF11)
      description: List all available task templates (operators/admins only)
      security:
        - tokenAuth: []
      responses:
        '200':
          description: List of task templates
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TaskTemplate'
        '403':
          description: Unauthorized
        '500':
          description: Failed to fetch templates
    post:
      summary: Create task template
      description: Create a new task template (operators/admins only)
      security:
        - tokenAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskTemplate'
      responses:
        '201':
          description: Task template created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskTemplate'
        '400':
          description: Validation error
        '403':
          description: Unauthorized
        '500':
          description: Failed to create template

  /tasks/templates/{id}:
    get:
      summary: Get task template by ID
      description: Get a specific task template (operators/admins only)
      security:
        - tokenAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Template ID
      responses:
        '200':
          description: Template details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskTemplate'
        '403':
          description: Unauthorized
        '404':
          description: Template not found
        '500':
          description: Failed to fetch template
    put:
      summary: Update task template
      description: Update a task template (operators/admins only)
      security:
        - tokenAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Template ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskTemplate'
      responses:
        '200':
          description: Template updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskTemplate'
        '400':
          description: Validation error
        '403':
          description: Unauthorized
        '404':
          description: Template not found
        '500':
          description: Failed to update template
    delete:
      summary: Deactivate task template
      description: Deactivate a task template (soft delete, operators/admins only)
      security:
        - tokenAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Template ID
      responses:
        '200':
          description: Template deactivated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskTemplate'
        '403':
          description: Unauthorized
        '404':
          description: Template not found
        '500':
          description: Failed to deactivate template

  /tasks/from-template:
    post:
      summary: Create task from template (RF11)
      description: Create a new task based on a template (operators/admins only)
      security:
        - tokenAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [template_id, title, description]
              properties:
                template_id:
                  type: string
                  description: ID of the template to use
                title:
                  type: string
                description:
                  type: string
      responses:
        '201':
          description: Task created from template
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '400':
          description: Missing required fields or validation error
        '403':
          description: Unauthorized
        '404':
          description: Template not found or inactive

  /tasks/{id}:
    get:
      summary: Get task by ID
      description: Get details of a specific task
      security:
        - tokenAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Task ID
      responses:
        '200':
          description: Task details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '401':
          description: Unauthorized
        '404':
          description: Task not found
    put:
      summary: Update task (Operators only)
      description: Update an existing task (operators/admins only)
      security:
        - tokenAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Task ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskCreate'
      responses:
        '200':
          description: Task updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '400':
          description: Validation error
        '403':
          description: Unauthorized - Operators only
        '404':
          description: Task not found
    delete:
      summary: Delete task (Operators only)
      description: Delete a task from the system (operators/admins only)
      security:
        - tokenAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Task ID
      responses:
        '204':
          description: Task deleted successfully
        '403':
          description: Unauthorized - Operators only
        '404':
          description: Task not found
        '500':
          description: Failed to delete task

  # ==================== QUIZZES ====================

  /quizzes:
    get:
      summary: List quizzes
      description: Get all quizzes (operators only)
      security:
        - tokenAuth: []
      responses:
        '200':
          description: List of quizzes with basic info
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    _id:
                      type: string
                    title:
                      type: string
                    description:
                      type: string
                    created_at:
                      type: string
                      format: date-time
        '403':
          description: Unauthorized - Operators only
        '500':
          description: Failed to fetch quizzes
    post:
      summary: Create quiz
      description: Create a new quiz (operators only)
      security:
        - tokenAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [title, questions]
              properties:
                title:
                  type: string
                description:
                  type: string
                passing_score:
                  type: number
                  description: Passing score as decimal (0.0-1.0) or percentage (0-100). Defaults to 0.8 (80%) if not provided
                questions:
                  type: array
                  items:
                    type: object
                    required: [text, options, correct_option_index]
                    properties:
                      text:
                        type: string
                      options:
                        type: array
                        items:
                          type: string
                      correct_option_index:
                        type: integer
                        description: Zero-based index of the correct option
      responses:
        '201':
          description: Quiz created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  _id:
                    type: string
                  title:
                    type: string
                  description:
                    type: string
                  created_at:
                    type: string
                    format: date-time
        '400':
          description: Invalid quiz data (missing title, empty questions, invalid passing score, or invalid question format)
        '403':
          description: Unauthorized - Operators only
        '500':
          description: Failed to create quiz

  /quizzes/{id}:
    get:
      summary: Get quiz by ID
      description: Get details of a specific quiz (questions returned without revealing correct answers)
      security:
        - tokenAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Quiz ID
      responses:
        '200':
          description: Quiz details with questions (correct answers obfuscated)
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  title:
                    type: string
                  description:
                    type: string
                  questions:
                    type: array
                    items:
                      type: object
                      properties:
                        text:
                          type: string
                        options:
                          type: array
                          items:
                            type: string
                  created_at:
                    type: string
                    format: date-time
        '400':
          description: Invalid quiz ID format
        '401':
          description: Unauthorized
        '404':
          description: Quiz not found
        '500':
          description: Failed to fetch quiz

  # ==================== NEIGHBORHOODS ====================

  /neighborhood:
    get:
      summary: List all neighborhoods
      description: Get list of all available neighborhoods
      responses:
        '200':
          description: List of neighborhoods
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Neighborhood'
        '500':
          description: Internal server error

  /neighborhood/ranking:
    get:
      summary: Get neighborhood ranking (RF17)
      description: Get neighborhoods ranked by normalized score
      parameters:
        - in: query
          name: period
          schema:
            type: string
            enum: [weekly, monthly, annually]
            default: annually
          description: Ranking period
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
          description: Max number of results
      responses:
        '200':
          description: Ranked neighborhoods with detailed stats
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    neighborhood_id:
                      type: string
                    name:
                      type: string
                    city:
                      type: string
                    rank:
                      type: integer
                      description: Ranking position
                    base_points:
                      type: number
                      description: Total points earned
                    normalized_points:
                      type: number
                      description: Points normalized by active users
                    participation_rate:
                      type: number
                      description: Percentage of active users (0-100)
                    improvement_factor:
                      type: number
                      description: change in points vs previous period
                    active_users:
                      type: integer
                    total_users:
                      type: integer
                    points_earned_in_period:
                      type: integer
                      description: Points earned in the specified period
                    environmental_data:
                      type: object
                      properties:
                        co2_saved:
                          type: number
                        waste_recycled:
                          type: number
                        km_green:
                          type: number
        '500':
          description: Internal server error

  /neighborhood/{id}:
    get:
      summary: Get neighborhood by ID
      description: Get details of a specific neighborhood
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Neighborhood ID
      responses:
        '200':
          description: Neighborhood details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Neighborhood'
        '400':
          description: Invalid ID
        '404':
          description: Neighborhood not found

  # ==================== OPERATORS ====================

  /operators/register:
    post:
      summary: Register new operator (Admin only)
      description: Create a new operator account and send activation email
      security:
        - tokenAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, surname, email]
              properties:
                name:
                  type: string
                surname:
                  type: string
                email:
                  type: string
                  format: email
      responses:
        '201':
          description: Operator created successfully
        '400':
          description: Missing required fields or invalid email format
        '403':
          description: Forbidden - Admin privileges required
        '409':
          description: Email already exists

  /operators/login:
    post:
      summary: Operator login
      description: Authenticate operator and receive JWT token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  role:
                    type: string
        '401':
          description: Wrong password
        '403':
          description: Account not activated or password not set
        '404':
          description: Operator not found

  /operators/reset-password:
    post:
      summary: Reset operator password
      description: Set new password using reset token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token, password]
              properties:
                token:
                  type: string
                  description: Password reset token
                password:
                  type: string
                  format: password
                  minLength: 6
      responses:
        '200':
          description: Password updated successfully
        '400':
          description: Missing fields, weak password, or invalid/expired token
        '500':
          description: Failed to reset password

  /operators/activate:
    post:
      summary: Activate operator account
      description: Set password and activate operator account using activation token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token:
                  type: string
                  description: Activation token received via email
                password:
                  type: string
                  format: password
                  minLength: 6
      responses:
        '200':
          description: Password set and account activated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: Missing fields, weak password, or invalid/expired token
        '403':
          description: This endpoint is only for operators

  /operators:
    get:
      summary: List all operators (Admin only)
      description: Get list of all operators
      security:
        - tokenAuth: []
      responses:
        '200':
          description: List of operators
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    _id:
                      type: string
                    name:
                      type: string
                    surname:
                      type: string
                    email:
                      type: string
                    role:
                      type: string
        '403':
          description: Unauthorized - Admin only
        '500':
          description: Failed to fetch operators

  /operators/{id}/force-reset-password:
    post:
      summary: Force password reset (Admin only)
      description: Force password reset for an operator and send email
      security:
        - tokenAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Operator ID
      responses:
        '200':
          description: Reset email sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '403':
          description: Unauthorized - Admin only
        '404':
          description: Operator not found
        '500':
          description: Failed to send reset email

  /operators/{id}:
    delete:
      summary: Delete operator (Admin only)
      description: Delete an operator from the system
      security:
        - tokenAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Operator ID
      responses:
        '204':
          description: Operator deleted successfully
        '403':
          description: Unauthorized - Admin only
        '404':
          description: Operator not found
        '500':
          description: Failed to delete operator

  /operators/dashboard/neighborhoods:
    get:
      summary: Get neighborhoods summary (RF10)
      description: Get summary stats for all neighborhoods
      security:
        - tokenAuth: []
      responses:
        '200':
          description: List of neighborhood summaries
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    name:
                      type: string
                    city:
                      type: string
                    base_points:
                      type: number
                    normalized_points:
                      type: number
                    ranking_position:
                      type: integer
                    user_count:
                      type: integer
                    submissions_this_week:
                      type: integer
                    completed_tasks:
                      type: integer
                    environmental_data:
                      type: object
                      properties:
                        co2_saved:
                          type: number
                        waste_recycled:
                          type: number
                        km_green:
                          type: number
                        last_updated:
                          type: string
                          format: date-time
        '403':
          description: Unauthorized - Operators only
        '500':
          description: Failed to fetch neighborhoods

  /operators/dashboard/neighborhoods/{id}:
    get:
      summary: Get neighborhood detail (RF10)
      description: Get detailed stats for a specific neighborhood including users, activity, and environmental data
      security:
        - tokenAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Neighborhood ID
      responses:
        '200':
          description: Detailed neighborhood stats
          content:
            application/json:
              schema:
                type: object
                properties:
                  neighborhood:
                    type: object
                    properties:
                      id:
                        type: string
                      name:
                        type: string
                      city:
                        type: string
                      base_points:
                        type: number
                      normalized_points:
                        type: number
                      ranking_position:
                        type: integer
                      environmental_data:
                        type: object
                        properties:
                          co2_saved:
                            type: number
                          waste_recycled:
                            type: number
                          km_green:
                            type: number
                  stats:
                    type: object
                    properties:
                      total_users:
                        type: integer
                      participation_rate:
                        type: number
                        description: Percentage of users who have completed tasks
                      submissions_by_category:
                        type: object
                        description: Count of submissions by task category
                  daily_activity:
                    type: array
                    items:
                      type: object
                      properties:
                        _id:
                          type: string
                          description: Date in YYYY-MM-DD format
                        count:
                          type: integer
                          description: Number of submissions on this date
                        points:
                          type: integer
                          description: Total points earned on this date
                  top_users:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        name:
                          type: string
                        points:
                          type: integer
                        level:
                          type: integer
                        tasks_completed:
                          type: integer
        '403':
          description: Unauthorized - Operators only
        '404':
          description: Neighborhood not found
        '500':
          description: Failed to fetch neighborhood data
  # ==================== REWARDS ====================

  /rewards:
    get:
      summary: List active rewards
      description: Get all active, non-expired rewards
      security:
        - tokenAuth: []
      responses:
        '200':
          description: List of active rewards
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Reward'
        '401':
          description: Unauthorized
        '500':
          description: Failed to fetch rewards
    post:
      summary: Create reward (Operators/Admins)
      description: Create a new reward in the catalog
      security:
        - tokenAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RewardCreate'
      responses:
        '201':
          description: Reward created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Reward'
        '400':
          description: Validation error
        '403':
          description: Unauthorized

  /rewards/all:
    get:
      summary: List all rewards (Operators/Admins)
      description: Get all rewards including inactive ones
      security:
        - tokenAuth: []
      responses:
        '200':
          description: Complete list of rewards
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Reward'
        '403':
          description: Unauthorized
        '500':
          description: Failed to fetch rewards

  /rewards/my-rewards:
    get:
      summary: Get user's redeemed rewards
      description: List rewards redeemed by the logged-in user
      security:
        - tokenAuth: []
      responses:
        '200':
          description: List of redeemed rewards
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserReward'
        '401':
          description: Unauthorized
        '500':
          description: Failed to fetch my rewards

  /rewards/{id}/redeem:
    post:
      summary: Redeem a reward
      description: Redeem a reward using accumulated points
      security:
        - tokenAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Reward ID
      responses:
        '200':
          description: Reward redeemed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  reward_title:
                    type: string
                  points_remaining:
                    type: integer
                  code:
                    type: string
                    description: Unique redemption code
        '400':
          description: Reward inactive, out of stock, expired, or insufficient points
        '401':
          description: Unauthorized
        '404':
          description: Reward or user not found

  /rewards/{id}:
    put:
      summary: Update reward (Operators/Admins)
      description: Update an existing reward
      security:
        - tokenAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Reward ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RewardCreate'
      responses:
        '200':
          description: Reward updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Reward'
        '400':
          description: Validation error
        '403':
          description: Unauthorized
        '404':
          description: Reward not found
    delete:
      summary: Delete reward (Operators/Admins)
      description: Delete a reward from the system
      security:
        - tokenAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Reward ID
      responses:
        '200':
          description: Reward deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '403':
          description: Unauthorized
        '404':
          description: Reward not found
        '500':
          description: Failed to delete reward

  # ==================== NOTIFICATIONS ====================

  /notifications:
    get:
      summary: Get user notifications
      description: Get notifications for the logged-in user
      security:
        - tokenAuth: []
      responses:
        '200':
          description: List of notifications
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Notification'
        '401':
          description: Unauthorized
        '500':
          description: Failed to fetch notifications

  /notifications/{id}/read:
    patch:
      summary: Mark notification as read
      description: Mark a single notification as read
      security:
        - tokenAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Notification ID
      responses:
        '200':
          description: Notification marked as read
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Notification'
        '401':
          description: Unauthorized
        '404':
          description: Notification not found
        '500':
          description: Failed to update notification

  /notifications/read-all:
    patch:
      summary: Mark all notifications as read
      description: Mark all notifications as read for the logged-in user
      security:
        - tokenAuth: []
      responses:
        '200':
          description: All notifications marked as read
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '401':
          description: Unauthorized
        '500':
          description: Failed to update notifications

  /notifications/preferences:
    get:
      summary: Get notification preferences
      description: Get current notification preferences for the logged-in user
      security:
        - tokenAuth: []
      responses:
        '200':
          description: Notification preferences
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationPreferences'
        '401':
          description: Unauthorized
        '404':
          description: User not found
        '500':
          description: Failed to fetch preferences
    patch:
      summary: Update notification preferences
      description: Update notification preferences for the logged-in user (RF5)
      security:
        - tokenAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NotificationPreferences'
      responses:
        '200':
          description: Preferences updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  preferences:
                    $ref: '#/components/schemas/NotificationPreferences'
        '401':
          description: Unauthorized
        '404':
          description: User not found
        '500':
          description: Failed to update preferences

  # ==================== STATS ====================

  /stats/public:
    get:
      summary: Get public statistics
      description: Get public aggregated statistics for landing page
      responses:
        '200':
          description: Public statistics
          content:
            application/json:
              schema:
                type: object
        '500':
          description: Failed to fetch statistics

# ==================== COMPONENTS ====================

components:
  securitySchemes:
    tokenAuth:
      type: apiKey
      in: header
      name: x-access-token
      description: JWT token for authentication

  schemas:
    Badge:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
        description:
          type: string
        icon:
          type: string
        category:
          type: string
        criteria:
          type: object

    Task:
      type: object
      properties:
        _id:
          type: string
        title:
          type: string
        description:
          type: string
        category:
          type: string
          enum: [Mobility, Waste, Community, Volunteering]
        base_points:
          type: integer
          description: Base points for the task
        difficulty:
          type: string
          enum: [Low, Medium, High]
        frequency:
          type: string
          enum: [daily, weekly, monthly, on_demand, onetime]
        verification_method:
          type: string
          enum: [GPS, QR_SCAN, PHOTO_UPLOAD, QUIZ]
        verification_criteria:
          type: object
          properties:
            min_distance_meters:
              type: number
            target_location:
              type: array
              items:
                type: number
            qr_code_secret:
              type: string
            photo_description:
              type: string
            quiz_id:
              type: string
        impact_metrics:
          type: object
          properties:
            co2_saved:
              type: number
            waste_recycled:
              type: number
            km_green:
              type: number
        neighborhood_id:
          type: string
        is_active:
          type: boolean
        template_id:
          type: string
        created_by:
          type: string
        created_at:
          type: string
          format: date-time

    TaskCreate:
      type: object
      required: [title, description, points]
      properties:
        title:
          type: string
        description:
          type: string
        category:
          type: string
          enum: [Mobility, Waste, Community, Volunteering]
        base_points:
          type: integer
          description: Base points for the task
        difficulty:
          type: string
          enum: [Low, Medium, High]
        frequency:
          type: string
          enum: [daily, weekly, monthly, on_demand, onetime]
        verification_method:
          type: string
          enum: [GPS, QR_SCAN, PHOTO_UPLOAD, QUIZ]
        verification_criteria:
          type: object
          properties:
            min_distance_meters:
              type: number
            target_location:
              type: array
              items:
                type: number
            qr_code_secret:
              type: string
            photo_description:
              type: string
            quiz_id:
              type: string
        impact_metrics:
          type: object
          properties:
            co2_saved:
              type: number
            waste_recycled:
              type: number
            km_green:
              type: number
        neighborhood_id:
          type: string
        is_active:
          type: boolean
        template_id:
          type: string

    TaskTemplate:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
        description:
          type: string
        category:
          type: string
          enum: [Mobility, Waste, Community, Education, Other]
        verification_method:
          type: string
          enum: [GPS, QR_SCAN, PHOTO_UPLOAD, QUIZ]
        default_difficulty:
          type: string
          enum: [Low, Medium, High]
        default_frequency:
          type: string
          enum: [daily, weekly, monthly, on_demand]
        base_points_range:
          type: object
          properties:
            min:
              type: integer
            max:
              type: integer
        configurable_fields:
          type: array
          items:
            type: object
            properties:
              field_name:
                type: string
              field_type:
                type: string
              description:
                type: string
              required:
                type: boolean
        is_active:
          type: boolean

    Quiz:
      type: object
      properties:
        _id:
          type: string
        title:
          type: string
        description:
          type: string
        passing_score:
          type: number
          description: Passing score as decimal (0.0-1.0)
        questions:
          type: array
          items:
            type: object
            properties:
              text:
                type: string
              options:
                type: array
                items:
                  type: string
              correct_option_index:
                type: integer
        created_at:
          type: string
          format: date-time

    Submission:
      type: object
      properties:
        _id:
          type: string
        user_id:
          type: string
        task_id:
          type: string
        status:
          type: string
          enum: [PENDING, APPROVED, REJECTED]
        proof:
          type: object
        submitted_at:
          type: string
          format: date-time

    Neighborhood:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
        city:
          type: string
        base_points:
          type: number
          description: Sum of all approved task points from neighborhood users
        normalized_points:
          type: number
          description: base_points adjusted for neighborhood size (base_points / active_users)
        ranking_position:
          type: integer
        last_ranking_update:
          type: string
          format: date-time
        environmental_data:
          type: object
          properties:
            co2_saved:
              type: number
              description: Total kg CO2 saved
            waste_recycled:
              type: number
              description: Total kg waste recycled
            km_green:
              type: number
              description: Total green km
            last_updated:
              type: string
              format: date-time

    Reward:
      type: object
      properties:
        _id:
          type: string
        title:
          type: string
        description:
          type: string
        points_cost:
          type: integer
        type:
          type: string
          enum: [COUPON, DIGITAL_BADGE, PHYSICAL_ITEM]
        provider:
          type: string
        quantity_available:
          type: integer
        active:
          type: boolean
        expiry_date:
          type: string
          format: date-time
        neighborhoods:
          type: array
          items:
            type: string
          description: IDs of neighborhoods where this reward is available (empty = available to all)
        created_at:
          type: string
          format: date-time

    RewardCreate:
      type: object
      required: [title, points_cost]
      properties:
        title:
          type: string
        description:
          type: string
        points_cost:
          type: integer
        type:
          type: string
          enum: [COUPON, DIGITAL_BADGE, PHYSICAL_ITEM]
        provider:
          type: string
        quantity_available:
          type: integer
        active:
          type: boolean
        expiry_date:
          type: string
          format: date-time
        neighborhoods:
          type: array
          items:
            type: string
          description: Array of neighborhood IDs where this reward is available (optional, empty = available to all)

    UserReward:
      type: object
      properties:
        _id:
          type: string
        user_id:
          type: string
        reward_id:
          $ref: '#/components/schemas/Reward'
        redeemed_at:
          type: string
          format: date-time
        unique_code:
          type: string

    Notification:
      type: object
      properties:
        _id:
          type: string
        user_id:
          type: string
        title:
          type: string
        message:
          type: string
        type:
          type: string
          enum: [feedback, info, motivational, reward, system]
        channel:
          type: string
          enum: [in-app, email, push]
        is_read:
          type: boolean
        metadata:
          type: object
        created_at:
          type: string
          format: date-time

    NotificationPreferences:
      type: object
      properties:
        daily:
          type: boolean
        email:
          type: boolean
        push:
          type: boolean
        motivational:
          type: boolean
        informational:
          type: boolean
        positive_reinforcement:
          type: boolean